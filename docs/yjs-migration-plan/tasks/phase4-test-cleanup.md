# フェーズ 4: テストと旧コード削除

**見積もり**: 0.5-1 日

## 概要

移行完了後の動作確認と、不要になった旧実装の削除を行います。

---

## 4.1 動作確認

### テスト項目

#### リアルタイム同期

- [ ] 複数ユーザーでの同時描画が正しく同期される
- [ ] ユーザー A の描画がユーザー B にリアルタイムで反映される
- [ ] 3 人以上のユーザーでも正しく同期される

#### Undo/Redo

- [ ] 自分の描画を Undo できる
- [ ] Undo した描画を Redo できる
- [ ] 他のユーザーの描画は Undo されない（自分の操作のみ）

#### 接続管理

- [ ] 接続切断時にエラー状態が表示される
- [ ] 再接続時に自動的に状態が同期される
- [ ] 長時間の切断後も再接続できる

#### オフライン動作

- [ ] オフライン時にローカルで描画できる
- [ ] オンライン復帰時にローカル変更が同期される
- [ ] 競合が発生しても正しくマージされる

#### 既存データ

- [ ] 既存の DynamoDB データが正しく読み込まれる
- [ ] 新しい描画が既存データに追加される
- [ ] 保存されたデータが JSON 形式を維持している

---

## 4.2 旧実装の削除

### 削除対象ファイル

| ファイル                                    | 理由                     |
| ------------------------------------------- | ------------------------ |
| `src/lib/konva/atoms/socketAtom.ts`         | Yjs atom に置き換え      |
| `src/lib/konva/atoms/drawingHistoryAtom.ts` | Y.UndoManager に置き換え |

### 変更対象ファイル

| ファイル                       | 変更内容                             |
| ------------------------------ | ------------------------------------ |
| `src/lib/konva/atoms/index.ts` | 削除した atom のエクスポートを削除   |
| `src/lib/konva/types.ts`       | `UndoRedoResult`型が不要になる可能性 |

### 削除対象の型定義

```typescript
// src/lib/konva/types.ts から削除可能
export type UndoRedoResult = {
  action: 'delete' | 'restore' | 'transform'
  objects: Drawing[]
}
```

---

## 4.3 コード量の変化（確認）

| 項目                  | 現在      | 移行後               |
| --------------------- | --------- | -------------------- |
| 履歴管理（undo/redo） | 約 200 行 | 約 20 行             |
| ソケット通信          | 約 160 行 | 約 50 行             |
| 競合解決ロジック      | 手動実装  | Yjs 自動処理         |
| イベント種別          | 7 種類    | Y.Map の変更監視のみ |

**削減行数**: 約 290 行 → 約 70 行（約 75%削減）

---

## 4.4 ドキュメント更新

### 更新対象

- [ ] README.md に環境変数の追加（`NEXT_PUBLIC_YJS_WS_URL`）
- [ ] 開発環境セットアップ手順の更新
- [ ] アーキテクチャドキュメントの更新

---

## 完了条件

- [ ] 全テスト項目がパス
- [ ] `socketAtom.ts`が削除されている
- [ ] `drawingHistoryAtom.ts`が削除されている
- [ ] 不要な型定義が削除されている
- [ ] ドキュメントが更新されている
- [ ] 本番環境で正常に動作している
